// Data Karakter Jepang
const japaneseData = {
  hiragana: [
    { char: "„ÅÇ", romaji: "a" },
    { char: "„ÅÑ", romaji: "i" },
    { char: "„ÅÜ", romaji: "u" },
    { char: "„Åà", romaji: "e" },
    { char: "„Åä", romaji: "o" },
    { char: "„Åã", romaji: "ka" },
    { char: "„Åç", romaji: "ki" },
    { char: "„Åè", romaji: "ku" },
    { char: "„Åë", romaji: "ke" },
    { char: "„Åì", romaji: "ko" },
    { char: "„Åï", romaji: "sa" },
    { char: "„Åó", romaji: "shi" },
    { char: "„Åô", romaji: "su" },
    { char: "„Åõ", romaji: "se" },
    { char: "„Åù", romaji: "so" },
    { char: "„Åü", romaji: "ta" },
    { char: "„Å°", romaji: "chi" },
    { char: "„Å§", romaji: "tsu" },
    { char: "„Å¶", romaji: "te" },
    { char: "„Å®", romaji: "to" },
    { char: "„Å™", romaji: "na" },
    { char: "„Å´", romaji: "ni" },
    { char: "„Å¨", romaji: "nu" },
    { char: "„Å≠", romaji: "ne" },
    { char: "„ÅÆ", romaji: "no" },
    { char: "„ÅØ", romaji: "ha" },
    { char: "„Å≤", romaji: "hi" },
    { char: "„Åµ", romaji: "fu" },
    { char: "„Å∏", romaji: "he" },
    { char: "„Åª", romaji: "ho" },
    { char: "„Åæ", romaji: "ma" },
    { char: "„Åø", romaji: "mi" },
    { char: "„ÇÄ", romaji: "mu" },
    { char: "„ÇÅ", romaji: "me" },
    { char: "„ÇÇ", romaji: "mo" },
    { char: "„ÇÑ", romaji: "ya" },
    { char: "„ÇÜ", romaji: "yu" },
    { char: "„Çà", romaji: "yo" },
    { char: "„Çâ", romaji: "ra" },
    { char: "„Çä", romaji: "ri" },
    { char: "„Çã", romaji: "ru" },
    { char: "„Çå", romaji: "re" },
    { char: "„Çç", romaji: "ro" },
    { char: "„Çè", romaji: "wa" },
    { char: "„Çí", romaji: "wo" },
    { char: "„Çì", romaji: "n" },
  ],
  katakana: [
    { char: "„Ç¢", romaji: "a" },
    { char: "„Ç§", romaji: "i" },
    { char: "„Ç¶", romaji: "u" },
    { char: "„Ç®", romaji: "e" },
    { char: "„Ç™", romaji: "o" },
    { char: "„Ç´", romaji: "ka" },
    { char: "„Ç≠", romaji: "ki" },
    { char: "„ÇØ", romaji: "ku" },
    { char: "„Ç±", romaji: "ke" },
    { char: "„Ç≥", romaji: "ko" },
    { char: "„Çµ", romaji: "sa" },
    { char: "„Ç∑", romaji: "shi" },
    { char: "„Çπ", romaji: "su" },
    { char: "„Çª", romaji: "se" },
    { char: "„ÇΩ", romaji: "so" },
    { char: "„Çø", romaji: "ta" },
    { char: "„ÉÅ", romaji: "chi" },
    { char: "„ÉÑ", romaji: "tsu" },
    { char: "„ÉÜ", romaji: "te" },
    { char: "„Éà", romaji: "to" },
    { char: "„Éä", romaji: "na" },
    { char: "„Éã", romaji: "ni" },
    { char: "„Éå", romaji: "nu" },
    { char: "„Éç", romaji: "ne" },
    { char: "„Éé", romaji: "no" },
    { char: "„Éè", romaji: "ha" },
    { char: "„Éí", romaji: "hi" },
    { char: "„Éï", romaji: "fu" },
    { char: "„Éò", romaji: "he" },
    { char: "„Éõ", romaji: "ho" },
    { char: "„Éû", romaji: "ma" },
    { char: "„Éü", romaji: "mi" },
    { char: "„É†", romaji: "mu" },
    { char: "„É°", romaji: "me" },
    { char: "„É¢", romaji: "mo" },
    { char: "„É§", romaji: "ya" },
    { char: "„É¶", romaji: "yu" },
    { char: "„É®", romaji: "yo" },
    { char: "„É©", romaji: "ra" },
    { char: "„É™", romaji: "ri" },
    { char: "„É´", romaji: "ru" },
    { char: "„É¨", romaji: "re" },
    { char: "„É≠", romaji: "ro" },
    { char: "„ÉØ", romaji: "wa" },
    { char: "„É≤", romaji: "wo" },
    { char: "„É≥", romaji: "n" },
  ],
  kanji: [
    { char: "Êó•", romaji: "„Å´„Å° / „Å≤", meaning: "hari, matahari" },
    { char: "‰∫∫", romaji: "„Åò„Çì / „Å≤„Å®", meaning: "orang" },
    { char: "Ê∞¥", romaji: "„Åô„ÅÑ / „Åø„Åö", meaning: "air" },
    { char: "ÁÅ´", romaji: "„Åã / „Å≤", meaning: "api" },
    { char: "Êú®", romaji: "„ÇÇ„Åè / „Åç", meaning: "pohon" },
    { char: "Èáë", romaji: "„Åç„Çì / „Åã„Å≠", meaning: "emas, uang" },
    { char: "Âúü", romaji: "„Å© / „Å§„Å°", meaning: "tanah" },
    { char: "Â±±", romaji: "„Åï„Çì / „ÇÑ„Åæ", meaning: "gunung" },
    { char: "Â∑ù", romaji: "„Åõ„Çì / „Åã„Çè", meaning: "sungai" },
    { char: "Â§©", romaji: "„Å¶„Çì", meaning: "langit" },
  ],
};

let progressData = JSON.parse(localStorage.getItem("japaneseProgress")) || {};

let currentSession = {
  questions: [],
  currentQuestion: 0,
  correctAnswers: 0,
  totalQuestions: 0,
  currentCategory: "hiragana",
};

function openTab(tabId) {
  const tabContents = document.getElementsByClassName("tab-content");
  for (let i = 0; i < tabContents.length; i++) {
    tabContents[i].classList.remove("active");
    tabContents[i].setAttribute("hidden", "hidden");
  }

  const tabButtons = document.getElementsByClassName("tab-btn");
  for (let i = 0; i < tabButtons.length; i++) {
    tabButtons[i].classList.remove("active");
    tabButtons[i].setAttribute("aria-selected", "false");
  }

  const activeTab = document.getElementById(tabId);
  activeTab.classList.add("active");
  activeTab.removeAttribute("hidden");

  const buttons = Array.from(tabButtons);
  const clickedButton = buttons.find(
    (btn) => btn.getAttribute("aria-controls") === tabId
  );
  if (clickedButton) {
    clickedButton.classList.add("active");
    clickedButton.setAttribute("aria-selected", "true");
    clickedButton.focus();
  }
}

function saveProgress() {
  localStorage.setItem("japaneseProgress", JSON.stringify(progressData));
}

// Render characters grid for each category
function displayCharacters() {
  ["hiragana", "katakana", "kanji"].forEach((category) => {
    const container = document.getElementById(`${category}-grid`);
    container.innerHTML = "";
    japaneseData[category].forEach((charData) => {
      // Key to progress is category + char for uniqueness
      const key = category + "_" + charData.char;
      const progress = progressData[key] || 0;
      const progressPercent = (progress / 20) * 100;
      const meaning =
        category === "kanji"
          ? `<div class="alphabet-meaning">${charData.meaning}</div>`
          : "";

      container.innerHTML += `
            <div class="alphabet-card ${progress >= 20 ? "learned" : ""}">
                <div class="alphabet-char">${charData.char}</div>
                <div class="alphabet-romaji">${charData.romaji}</div>
                ${meaning}
                <div class="progress-container">
                    <div class="progress-bar" style="width: ${progressPercent}%"></div>
                </div>
            </div>
            `;
    });
  });
}

function startPracticeSession() {
  // Detect current active tab/category
  const activeCategoryBtn = document.querySelector(".tab-btn.active");
  currentSession.currentCategory = activeCategoryBtn
    ? activeCategoryBtn.getAttribute("aria-controls")
    : "hiragana";

  currentSession.totalQuestions = Math.floor(Math.random() * 11) + 10; // 10-20 questions
  currentSession.questions = [];
  currentSession.currentQuestion = 0;
  currentSession.correctAnswers = 0;

  const charPool = japaneseData[currentSession.currentCategory];

  // Randomly pick questions
  for (let i = 0; i < currentSession.totalQuestions; i++) {
    const randomIndex = Math.floor(Math.random() * charPool.length);
    currentSession.questions.push(charPool[randomIndex]);
  }

  showNextQuestion();
}

function showNextQuestion() {
  if (currentSession.currentQuestion >= currentSession.totalQuestions) {
    showResults();
    return;
  }

  const modal = document.getElementById("practice-modal");
  const quizChar = document.getElementById("quiz-char");
  const quizOptions = document.getElementById("quiz-options");
  const feedback = document.getElementById("feedback");

  feedback.textContent = "";
  feedback.className = "feedback";

  const currentChar = currentSession.questions[currentSession.currentQuestion];
  quizChar.textContent = currentChar.char;

  quizOptions.innerHTML = "";

  let correctAnswer =
    currentSession.currentCategory === "kanji"
      ? currentChar.meaning
      : currentChar.romaji;

  // Collect options: start with correct, then add random wrong options from same category
  let options = [correctAnswer];
  const charPool = japaneseData[currentSession.currentCategory];
  let valuesPool = charPool.map((c) =>
    currentSession.currentCategory === "kanji" ? c.meaning : c.romaji
  );

  while (options.length < 4) {
    let randomIndex = Math.floor(Math.random() * valuesPool.length);
    let val = valuesPool[randomIndex];
    if (!options.includes(val)) options.push(val);
  }

  // Shuffle options
  options = options.sort(() => 0.5 - Math.random());

  options.forEach((option) => {
    const optionBtn = document.createElement("div");
    optionBtn.className = "quiz-option";
    optionBtn.textContent = option;
    optionBtn.onclick = () =>
      checkAnswer(currentChar.char, option, correctAnswer);
    quizOptions.appendChild(optionBtn);
  });

  modal.style.display = "flex";
  modal.focus();
}

function checkAnswer(char, selected, correct) {
  const options = document.querySelectorAll(".quiz-option");
  const feedback = document.getElementById("feedback");

  options.forEach((option) => (option.onclick = null));

  const key = currentSession.currentCategory + "_" + char;

  if (selected === correct) {
    currentSession.correctAnswers++;
    progressData[key] = (progressData[key] || 0) + 1;
    saveProgress();

    feedback.textContent = "Benar! [üëçüèª]";
    feedback.className = "feedback correct";

    options.forEach((option) => {
      if (option.textContent === correct) option.classList.add("correct");
    });
  } else {
    feedback.textContent = `Salah! Jawaban benar: ${correct}`;
    feedback.className = "feedback incorrect";

    options.forEach((option) => {
      if (option.textContent === selected) option.classList.add("incorrect");
      if (option.textContent === correct) option.classList.add("correct");
    });
  }

  setTimeout(() => {
    currentSession.currentQuestion++;
    showNextQuestion();
  }, 1500);
}

function showResults() {
  closeModal();

  const resultModal = document.getElementById("result-modal");
  const resultScore = document.getElementById("result-score");
  const resultMessage = document.getElementById("result-message");

  const score = Math.round(
    (currentSession.correctAnswers / currentSession.totalQuestions) * 100
  );
  resultScore.textContent = `Skor: ${score}% (${currentSession.correctAnswers}/${currentSession.totalQuestions} benar)`;

  if (score >= 80) {
    resultMessage.textContent =
      "Luar biasa! Anda sangat menguasai karakter Jepang!";
  } else if (score >= 60) {
    resultMessage.textContent =
      "Bagus! Terus berlatih untuk hasil yang lebih baik!";
  } else {
    resultMessage.textContent =
      "Terus berlatih ya! Anda pasti bisa menguasainya!";
  }

  displayCharacters();

  resultModal.style.display = "flex";
  resultModal.focus();
}

function closeModal() {
  document.getElementById("practice-modal").style.display = "none";
}

function closeResultModal() {
  document.getElementById("result-modal").style.display = "none";
}

function toggleTheme() {
  document.body.classList.toggle("dark-mode");
}

window.onload = () => {
  displayCharacters();
};
